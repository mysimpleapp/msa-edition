<link rel="import" href="../mysimpleapp/mysimpleapp.pack.html"></link>
<script src="../PicoModal/src/picoModal.js"></script>
<style>
	.selected_for_edition {
		box-shadow: 0pt 0pt 3pt 1pt #aaf;
	}
	.boxable msa-box, .boxable msa-box-partial {
		outline: 1px dashed #555;
	}
</style>
<!-- msa-editor template -->
<template id="msa-editor">
	<style>
		:host {
			position: absolute;
			top: 50px;
			left: 50px;
		}
		.editor {
			line-height: 0;
			background-color: white;
			padding: 3px;
			box-shadow: 1pt 1pt 2pt 1pt #aaa;
		}
		.editor input {
			padding: 5px;
			outline: 0;
			width: 24px;
			height: 24px;
		}
		.editor input.separator {
			border-right: 1px solid #aaa;
		}
		#anchor {
			padding: 5px;
			outline: 0;
			width: 24px;
			height: 12px;
			border-radius: 3pt;
		}
		.editor input:hover {
			box-shadow: 1pt 1pt 3pt 1pt #aaa;
			border-radius: 3pt;
		}
		.editor input.active {
			background-color: #ddd;
			border-radius: 3pt;
		}
	</style>
	<div class="editor">
		<div>
			<input ?onmouseover="show='edit'" ?class="show=='edit'?'active':''" type="image" src='data:image/svg+xml;utf8,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20fill%3D%22%23999%22%20viewBox%3D%220%200%201024%201024%22%3E%3Cpath%20d%3D%22M864%200c88.364%200%20160%2071.634%20160%20160%200%2036.020-11.91%2069.258-32%2096l-64%2064-224-224%2064-64c26.742-20.090%2059.978-32%2096-32zM64%20736l-64%20288%20288-64%20592-592-224-224-592%20592zM715.578%20363.578l-448%20448-55.156-55.156%20448-448%2055.156%2055.156z%22%2F%3E%3C%2Fsvg%3E'>
			<input ?onmouseover="show='text'" ?class="show=='text'?'active':''" type="image" src='data:image/svg+xml;utf8,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20fill%3D%22%23999%22%20viewBox%3D%220%200%201024%201024%22%3E%3Cpath%20class%3D%22path1%22%20d%3D%22M896%200h-768c-17.664%200-32%2014.336-32%2032v192c0%2017.664%2014.336%2032%2032%2032h32c17.664%200%2032-14.336%2032-32l64-96h192v768l-160%2064c-17.664%200-32%2014.304-32%2032s14.336%2032%2032%2032h448c17.696%200%2032-14.304%2032-32s-14.304-32-32-32l-160-64v-768h192l64%2096c0%2017.664%2014.304%2032%2032%2032h32c17.696%200%2032-14.336%2032-32v-192c0-17.664-14.304-32-32-32z%22%3E%3C%2Fpath%3E%0A%3C%2Fsvg%3E'>
			<input ?onmouseover="show='indent'" ?class="show=='indent'?'active':''" type="image" src='data:image/svg+xml;utf8,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20fill%3D%22%23999%22%20viewBox%3D%220%200%201024%201024%22%3E%3Cpath%20class%3D%22path1%22%20d%3D%22M0%2064h1024v128h-1024zM0%20256h1024v128h-1024zM0%20448h1024v128h-1024zM0%20640h1024v128h-1024zM0%20832h1024v128h-1024z%22%3E%3C%2Fpath%3E%0A%0A%3C%2Fsvg%3E'>
			<input ?onmouseover="show='color'" ?class="show=='color'?'active':''" type="image" src='data:image/svg+xml;utf8,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20fill%3D%22%23999%22%20viewBox%3D%220%200%201024%201024%22%3E%3Cpath%20class%3D%22path1%22%20d%3D%22M746%20512q26%200%2045-18t19-46-19-46-45-18-45%2018-19%2046%2019%2046%2045%2018zM618%20342q26%200%2045-19t19-45-19-45-45-19-45%2019-19%2045%2019%2045%2045%2019zM406%20342q26%200%2045-19t19-45-19-45-45-19-45%2019-19%2045%2019%2045%2045%2019zM278%20512q26%200%2045-18t19-46-19-46-45-18-45%2018-19%2046%2019%2046%2045%2018zM512%20128q158%200%20271%20100t113%20242q0%2088-63%20150t-151%2062h-74q-28%200-46%2019t-18%2045q0%2022%2016%2042t16%2044q0%2028-18%2046t-46%2018q-160%200-272-112t-112-272%20112-272%20272-112z%22%3E%3C%2Fpath%3E%0A%3C%2Fsvg%3E'>
			<input ?onmouseover="show='box'" ?class="show=='box'?'active':''" type="image" src='data:image/svg+xml;utf8,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20fill%3D%22%23999%22%20viewBox%3D%220%200%201024%201024%22%3E%3Cpath%20d%3D%22M896%200h-768c-70.4%200-128%2057.6-128%20128v768c0%2070.4%2057.6%20128%20128%20128h768c70.4%200%20128-57.6%20128-128v-768c0-70.4-57.6-128-128-128zM896%20896h-768v-768h768v768z%22%2F%3E%3C%2Fsvg%3E'>
			<input ?onmouseover="show=''" ?onclick="showSource()" type="image" src='data:image/svg+xml;utf8,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20fill%3D%22%23999%22%20viewBox%3D%220%200%201280%201024%22%3E%3Cpath%20class%3D%22path1%22%20d%3D%22M832%20736l96%2096%20320-320-320-320-96%2096%20224%20224z%22%3E%3C%2Fpath%3E%3Cpath%20class%3D%22path2%22%20d%3D%22M448%20288l-96-96-320%20320%20320%20320%2096-96-224-224z%22%3E%3C%2Fpath%3E%3Cpath%20class%3D%22path3%22%20d%3D%22M701.298%20150.519l69.468%2018.944-191.987%20704.026-69.468-18.944%20191.987-704.026z%22%3E%3C%2Fpath%3E%3C%2Fsvg%3E'>
		</div>
		<div ?if="show!=''" style="border-bottom: 1px solid #aaa; margin-bottom: 3px; padding-bottom: 3px"></div>
		<div ?if="show=='edit'">
			<input ?onclick="copy()" type="image" src='data:image/svg+xml;utf8,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20fill%3D%22%23999%22%20viewBox%3D%220%200%201024%201024%22%3E%3Cpath%20class%3D%22path1%22%20d%3D%22M640%20256v-256h-448l-192%20192v576h384v256h640v-768h-384zM192%2090.51v101.49h-101.49l101.49-101.49zM64%20704v-448h192v-192h320v192l-192%20192v256h-320zM576%20346.51v101.49h-101.49l101.49-101.49zM960%20960h-512v-448h192v-192h320v640z%22%3E%3C%2Fpath%3E%0A%3C%2Fsvg%3E'>
			<input ?onclick="cut()" type="image" src='data:image/svg+xml;utf8,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20fill%3D%22%23999%22%20viewBox%3D%220%200%201024%201024%22%3E%3Cpath%20class%3D%22path1%22%20d%3D%22M913.826%20679.694c-66.684-104.204-181.078-150.064-255.51-102.434-6.428%204.116-12.334%208.804-17.744%2013.982l-79.452-124.262%20183.462-287.972c15.016-27.73%2020.558-60.758%2013.266-93.974-6.972-31.75-24.516-58.438-48.102-77.226l-12.278-7.808-217.468%20340.114-217.47-340.114-12.276%207.806c-23.586%2018.79-41.13%2045.476-48.1%2077.226-7.292%2033.216-1.75%2066.244%2013.264%2093.974l183.464%20287.972-79.454%20124.262c-5.41-5.178-11.316-9.868-17.744-13.982-74.432-47.63-188.826-1.77-255.51%20102.434-66.68%20104.2-60.398%20227.286%2014.032%20274.914%2074.43%2047.632%20188.824%201.77%20255.508-102.432l164.286-257.87%20164.288%20257.872c66.684%20104.202%20181.078%20150.064%20255.508%20102.432%2074.428-47.63%2080.71-170.716%2014.030-274.914zM234.852%20800.43c-30.018%2046.904-68.534%2069.726-94.572%2075.446-0.004%200-0.004%200-0.004%200-8.49%201.868-20.294%203.010-28.324-2.128-8.898-5.694-14.804-20.748-15.8-40.276-1.616-31.644%209.642-68.836%2030.888-102.034%2030.014-46.906%2068.53-69.726%2094.562-75.444%208.496-1.866%2020.308-3.010%2028.336%202.126%208.898%205.694%2014.802%2020.75%2015.798%2040.272%201.618%2031.65-9.64%2068.84-30.884%20102.038zM480%20512c-17.672%200-32-14.328-32-32s14.328-32%2032-32%2032%2014.328%2032%2032-14.328%2032-32%2032zM863.85%20833.47c-0.996%2019.528-6.902%2034.582-15.8%2040.276-8.030%205.138-19.834%203.996-28.324%202.128%200%200%200%200-0.004%200-26.040-5.718-64.554-28.542-94.572-75.446-21.244-33.198-32.502-70.388-30.884-102.038%200.996-19.522%206.9-34.578%2015.798-40.272%208.028-5.136%2019.84-3.992%2028.336-2.126%2026.034%205.716%2064.548%2028.538%2094.562%2075.444%2021.246%2033.198%2032.502%2070.39%2030.888%20102.034z%22%3E%3C%2Fpath%3E%0A%3C%2Fsvg%3E'>
			<input ?onclick="paste()" class="separator" type="image" src='data:image/svg+xml;utf8,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20fill%3D%22%23999%22%20viewBox%3D%220%200%201024%201024%22%3E%3Cpath%20class%3D%22path1%22%20d%3D%22M704%20128h-128v-64c0-35.2-28.8-64-64-64h-128c-35.204%200-64%2028.8-64%2064v64h-128v128h512v-128zM512%20128h-128v-63.886c0.034-0.038%200.072-0.078%200.114-0.114h127.768c0.042%200.036%200.082%200.076%200.118%200.114v63.886zM832%20320v-160c0-17.6-14.4-32-32-32h-64v64h32v128h-192l-192%20192v256h-256v-576h32v-64h-64c-17.602%200-32%2014.4-32%2032v640c0%2017.6%2014.398%2032%2032%2032h288v192h640v-704h-192zM576%20410.51v101.49h-101.49l101.49-101.49zM960%20960h-512v-384h192v-192h320v576z%22%3E%3C%2Fpath%3E%0A%3C%2Fsvg%3E'>
			<input ?onclick="undo()" type="image" src='data:image/svg+xml;utf8,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20fill%3D%22%23999%22%20viewBox%3D%220%200%201024%201024%22%3E%3Cpath%20class%3D%22path1%22%20d%3D%22M761.862%201024c113.726-206.032%20132.888-520.306-313.862-509.824v253.824l-384-384%20384-384v248.372c534.962-13.942%20594.57%20472.214%20313.862%20775.628z%22%3E%3C%2Fpath%3E%0A%3C%2Fsvg%3E'>
			<input ?onclick="redo()" type="image" src='data:image/svg+xml;utf8,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20fill%3D%22%23999%22%20viewBox%3D%220%200%201024%201024%22%3E%3Cpath%20class%3D%22path1%22%20d%3D%22M576%20248.372v-248.372l384%20384-384%20384v-253.824c-446.75-10.482-427.588%20303.792-313.86%20509.824-280.712-303.414-221.1-789.57%20313.86-775.628z%22%3E%3C%2Fpath%3E%0A%3C%2Fsvg%3E'>
		</div>
		<div ?if="show=='text'">
			<input ?onclick="bold()" type="image" src='data:image/svg+xml;utf8,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20fill%3D%22%23999%22%20viewBox%3D%220%200%2032%2032%22%3E%3Cpath%20d%3D%22M22.121%2015.145c1.172-1.392%201.879-3.188%201.879-5.145%200-4.411-3.589-8-8-8h-10v28h12c4.411%200%208-3.589%208-8%200-2.905-1.556-5.453-3.879-6.855zM12%206h3.172c1.749%200%203.172%201.794%203.172%204s-1.423%204-3.172%204h-3.172v-8zM16.969%2026h-4.969v-8h4.969c1.827%200%203.313%201.794%203.313%204s-1.486%204-3.313%204z%22%2F%3E%3C%2Fsvg%3E'>
			<input ?onclick="italic()" type="image" src='data:image/svg+xml;utf8,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20fill%3D%22%23999%22%20viewBox%3D%220%200%2032%2032%22%3E%3Cpath%20d%3D%22M28%202v2h-4l-10%2024h4v2h-14v-2h4l10-24h-4v-2z%22%2F%3E%3C%2Fsvg%3E'>
			<input ?onclick="underline()" type="image" src='data:image/svg+xml;utf8,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20fill%3D%22%23999%22%20viewBox%3D%220%200%2032%2032%22%3E%3Cpath%20d%3D%22M22%202h4v13c0%204.971-4.477%209-10%209s-10-4.029-10-9v-13h4v13c0%201.255%200.57%202.459%201.605%203.391%201.153%201.038%202.714%201.609%204.395%201.609s3.242-0.572%204.395-1.609c1.035-0.931%201.605-2.136%201.605-3.391v-13zM6%2026h20v4h-20z%22%2F%3E%3C%2Fsvg%3E'>
			<input ?onclick="strikethrough()" class="separator" type="image" src='data:image/svg+xml;utf8,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20fill%3D%22%23999%22%20viewBox%3D%220%200%2032%2032%22%3E%3Cpath%20d%3D%22M32%2016v2h-7.328c0.86%201.203%201.328%202.584%201.328%204%200%202.215-1.146%204.345-3.143%205.843-1.855%201.391-4.29%202.157-6.857%202.157s-5.002-0.766-6.857-2.157c-1.998-1.498-3.143-3.628-3.143-5.843h4c0%202.168%202.748%204%206%204s6-1.832%206-4c0-2.168-2.748-4-6-4h-16v-2h9.36c-0.073-0.052-0.146-0.104-0.217-0.157-1.998-1.498-3.143-3.628-3.143-5.843s1.146-4.345%203.143-5.843c1.855-1.391%204.29-2.157%206.857-2.157s5.002%200.766%206.857%202.157c1.997%201.498%203.143%203.628%203.143%205.843h-4c0-2.168-2.748-4-6-4s-6%201.832-6%204c0%202.168%202.748%204%206%204%202.468%200%204.814%200.709%206.64%202h9.36z%22%2F%3E%3C%2Fsvg%3E'>
			<input ?onclick="removeFormat()" class="separator" type="image" src='data:image/svg+xml;utf8,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20fill%3D%22%23999%22%20viewBox%3D%220%200%2032%2032%22%3E%3Cpath%20d%3D%22M0%2028h18v4h-18zM28%204h-9.455l-5.743%2022h-4.134l5.743-22h-8.411v-4h22zM29.055%2032l-4.055-4.055-4.055%204.055-1.945-1.945%204.055-4.055-4.055-4.055%201.945-1.945%204.055%204.055%204.055-4.055%201.945%201.945-4.055%204.055%204.055%204.055z%22%2F%3E%3C%2Fsvg%3E'>
			<input ?onclick="createLink()" type="image" src='data:image/svg+xml;utf8,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20fill%3D%22%23999%22%20viewBox%3D%220%200%20951%201024%22%3E%3Cpath%20class%3D%22path1%22%20d%3D%22M832%20694.857q0-22.857-16-38.857l-118.857-118.857q-16-16-38.857-16-24%200-41.143%2018.286%201.714%201.714%2010.857%2010.571t12.286%2012.286%208.571%2010.857%207.429%2014.571%202%2015.714q0%2022.857-16%2038.857t-38.857%2016q-8.571%200-15.714-2t-14.571-7.429-10.857-8.571-12.286-12.286-10.571-10.857q-18.857%2017.714-18.857%2041.714%200%2022.857%2016%2038.857l117.714%20118.286q15.429%2015.429%2038.857%2015.429%2022.857%200%2038.857-14.857l84-83.429q16-16%2016-38.286zM430.286%20292q0-22.857-16-38.857l-117.714-118.286q-16-16-38.857-16-22.286%200-38.857%2015.429l-84%2083.429q-16%2016-16%2038.286%200%2022.857%2016%2038.857l118.857%20118.857q15.429%2015.429%2038.857%2015.429%2024%200%2041.143-17.714-1.714-1.714-10.857-10.571t-12.286-12.286-8.571-10.857-7.429-14.571-2-15.714q0-22.857%2016-38.857t38.857-16q8.571%200%2015.714%202t14.571%207.429%2010.857%208.571%2012.286%2012.286%2010.571%2010.857q18.857-17.714%2018.857-41.714zM941.714%20694.857q0%2068.571-48.571%20116l-84%2083.429q-47.429%2047.429-116%2047.429-69.143%200-116.571-48.571l-117.714-118.286q-47.429-47.429-47.429-116%200-70.286%2050.286-119.429l-50.286-50.286q-49.143%2050.286-118.857%2050.286-68.571%200-116.571-48l-118.857-118.857q-48-48-48-116.571t48.571-116l84-83.429q47.429-47.429%20116-47.429%2069.143%200%20116.571%2048.571l117.714%20118.286q47.429%2047.429%2047.429%20116%200%2070.286-50.286%20119.429l50.286%2050.286q49.143-50.286%20118.857-50.286%2068.571%200%20116.571%2048l118.857%20118.857q48%2048%2048%20116.571z%22%3E%3C%2Fpath%3E%0A%3C%2Fsvg%3E'>
			<input ?onclick="unlink()" type="image" src='data:image/svg+xml;utf8,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20fill%3D%22%23999%22%20viewBox%3D%220%200%20951%201024%22%3E%3Cpath%20class%3D%22path1%22%20d%3D%22M250.857%20726.286l-146.286%20146.286q-5.714%205.143-13.143%205.143-6.857%200-13.143-5.143-5.143-5.714-5.143-13.143t5.143-13.143l146.286-146.286q5.714-5.143%2013.143-5.143t13.143%205.143q5.143%205.714%205.143%2013.143t-5.143%2013.143zM347.429%20749.714v182.857q0%208-5.143%2013.143t-13.143%205.143-13.143-5.143-5.143-13.143v-182.857q0-8%205.143-13.143t13.143-5.143%2013.143%205.143%205.143%2013.143zM219.429%20621.714q0%208-5.143%2013.143t-13.143%205.143h-182.857q-8%200-13.143-5.143t-5.143-13.143%205.143-13.143%2013.143-5.143h182.857q8%200%2013.143%205.143t5.143%2013.143zM941.714%20694.857q0%2068.571-48.571%20116l-84%2083.429q-47.429%2047.429-116%2047.429-69.143%200-116.571-48.571l-190.857-191.429q-12-12-24-32l136.571-10.286%20156%20156.571q15.429%2015.429%2038.857%2015.714t38.857-15.143l84-83.429q16-16%2016-38.286%200-22.857-16-38.857l-156.571-157.143%2010.286-136.571q20%2012%2032%2024l192%20192q48%2049.143%2048%20116.571zM589.143%20281.143l-136.571%2010.286-156-156.571q-16-16-38.857-16-22.286%200-38.857%2015.429l-84%2083.429q-16%2016-16%2038.286%200%2022.857%2016%2038.857l156.571%20156.571-10.286%20137.143q-20-12-32-24l-192-192q-48-49.143-48-116.571%200-68.571%2048.571-116l84-83.429q47.429-47.429%20116-47.429%2069.143%200%20116.571%2048.571l190.857%20191.429q12%2012%2024%2032zM950.857%20329.143q0%208-5.143%2013.143t-13.143%205.143h-182.857q-8%200-13.143-5.143t-5.143-13.143%205.143-13.143%2013.143-5.143h182.857q8%200%2013.143%205.143t5.143%2013.143zM640%2018.286v182.857q0%208-5.143%2013.143t-13.143%205.143-13.143-5.143-5.143-13.143v-182.857q0-8%205.143-13.143t13.143-5.143%2013.143%205.143%205.143%2013.143zM872.571%20104.571l-146.286%20146.286q-6.286%205.143-13.143%205.143t-13.143-5.143q-5.143-5.714-5.143-13.143t5.143-13.143l146.286-146.286q5.714-5.143%2013.143-5.143t13.143%205.143q5.143%205.714%205.143%2013.143t-5.143%2013.143z%22%3E%3C%2Fpath%3E%0A%3C%2Fsvg%3E'>
		</div>
		<div ?if="show=='indent'">
			<input ?onclick="justifyLeft()" type="image" src='data:image/svg+xml;utf8,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20fill%3D%22%23999%22%20viewBox%3D%220%200%2032%2032%22%3E%3Cpath%20d%3D%22M0%202h32v4h-32zM0%208h20v4h-20zM0%2020h20v4h-20zM0%2014h32v4h-32zM0%2026h32v4h-32z%22%2F%3E%3C%2Fsvg%3E'>
			<input ?onclick="justifyCenter()" type="image" src='data:image/svg+xml;utf8,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20fill%3D%22%23999%22%20viewBox%3D%220%200%2032%2032%22%3E%3Cpath%20d%3D%22M0%202h32v4h-32zM6%208h20v4h-20zM6%2020h20v4h-20zM0%2014h32v4h-32zM0%2026h32v4h-32z%22%2F%3E%3C%2Fsvg%3E'>
			<input ?onclick="justifyRight()" type="image" src='data:image/svg+xml;utf8,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20fill%3D%22%23999%22%20viewBox%3D%220%200%2032%2032%22%3E%3Cpath%20d%3D%22M0%202h32v4h-32zM12%208h20v4h-20zM12%2020h20v4h-20zM0%2014h32v4h-32zM0%2026h32v4h-32z%22%2F%3E%3C%2Fsvg%3E'>
			<input ?onclick="justifyFull()" class="separator" type="image" src='data:image/svg+xml;utf8,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20fill%3D%22%23999%22%20viewBox%3D%220%200%201024%201024%22%3E%3Cpath%20class%3D%22path1%22%20d%3D%22M0%2064h1024v128h-1024zM0%20256h1024v128h-1024zM0%20448h1024v128h-1024zM0%20640h1024v128h-1024zM0%20832h1024v128h-1024z%22%3E%3C%2Fpath%3E%0A%0A%3C%2Fsvg%3E'>
			<input ?onclick="indent()" type="image" src='data:image/svg+xml;utf8,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20fill%3D%22%23999%22%20viewBox%3D%220%200%2032%2032%22%3E%3Cpath%20d%3D%22M0%202h32v4h-32zM12%208h20v4h-20zM12%2014h20v4h-20zM12%2020h20v4h-20zM0%2026h32v4h-32zM0%2022v-12l8%206z%22%2F%3E%3C%2Fsvg%3E'>
			<input ?onclick="outdent()" class="separator" type="image" src='data:image/svg+xml;utf8,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20fill%3D%22%23999%22%20viewBox%3D%220%200%2032%2032%22%3E%3Cpath%20d%3D%22M0%202h32v4h-32zM12%208h20v4h-20zM12%2014h20v4h-20zM12%2020h20v4h-20zM0%2026h32v4h-32zM8%2010v12l-8-6z%22%2F%3E%3C%2Fsvg%3E'>
			<input ?onclick="insertUnorderedList()" type="image" src='data:image/svg+xml;utf8,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20fill%3D%22%23999%22%20viewBox%3D%220%200%2032%2032%22%3E%3Cpath%20d%3D%22M12%202h20v4h-20v-4zM12%2014h20v4h-20v-4zM12%2026h20v4h-20v-4zM0%204c0-2.209%201.791-4%204-4s4%201.791%204%204c0%202.209-1.791%204-4%204s-4-1.791-4-4zM0%2016c0-2.209%201.791-4%204-4s4%201.791%204%204c0%202.209-1.791%204-4%204s-4-1.791-4-4zM0%2028c0-2.209%201.791-4%204-4s4%201.791%204%204c0%202.209-1.791%204-4%204s-4-1.791-4-4z%22%2F%3E%3C%2Fsvg%3E'>
			<input ?onclick="insertOrderedList()" type="image" src='data:image/svg+xml;utf8,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20fill%3D%22%23999%22%20viewBox%3D%220%200%2032%2032%22%3E%3Cpath%20d%3D%22M12%2026h20v4h-20zM12%2014h20v4h-20zM12%202h20v4h-20zM6%200v8h-2v-6h-2v-2zM4%2016.438v1.563h4v2h-6v-4.563l4-1.875v-1.563h-4v-2h6v4.563zM8%2022v10h-6v-2h4v-2h-4v-2h4v-2h-4v-2z%22%2F%3E%3C%2Fsvg%3E'>
		</div>
		<div ?if="show=='color'">
			<input ?onclick="foreColor()" type="image" src='data:image/svg+xml;utf8,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20fill%3D%22red%22%20viewBox%3D%220%200%2032%2032%22%3E%3Cpath%20d%3D%22M10.063%2026l1.8-6h8.274l1.8%206h3.551l-6-20h-6.976l-6%2020h3.551zM14.863%2010h2.274l1.8%206h-5.874l1.8-6z%22%2F%3E%3C%2Fsvg%3E'>
			<input ?onclick="backColor()" type="image" style="background-color:red" src='data:image/svg+xml;utf8,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20fill%3D%22white%22%20viewBox%3D%220%200%2032%2032%22%3E%3Cpath%20d%3D%22M10.063%2026l1.8-6h8.274l1.8%206h3.551l-6-20h-6.976l-6%2020h3.551zM14.863%2010h2.274l1.8%206h-5.874l1.8-6z%22%2F%3E%3C%2Fsvg%3E'>
			<input ?onclick="colorBackground()" type="image" src='data:image/svg+xml;utf8,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20fill%3D%22%23999%22%20viewBox%3D%220%200%201024%201024%22%3E%3Cpath%20class%3D%22path1%22%20d%3D%22M1024%20576v-384h-192v-64c0-35.2-28.8-64-64-64h-704c-35.2%200-64%2028.8-64%2064v192c0%2035.2%2028.8%2064%2064%2064h704c35.2%200%2064-28.8%2064-64v-64h128v256h-576v128h-32c-17.674%200-32%2014.326-32%2032v320c0%2017.674%2014.326%2032%2032%2032h128c17.674%200%2032-14.326%2032-32v-320c0-17.674-14.326-32-32-32h-32v-64h576zM768%20192h-704v-64h704v64z%22%2F%3E%3C%2Fsvg%3E'>
		</div>
		<div ?if="show=='box'">
			<input ?onclick="insertBox()" type="image" src='data:image/svg+xml;utf8,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20fill%3D%22%23999%22%20viewBox%3D%220%200%201024%201024%22%3E%3Cpath%20class%3D%22path1%22%20d%3D%22M992%20384h-352v-352c0-17.672-14.328-32-32-32h-192c-17.672%200-32%2014.328-32%2032v352h-352c-17.672%200-32%2014.328-32%2032v192c0%2017.672%2014.328%2032%2032%2032h352v352c0%2017.672%2014.328%2032%2032%2032h192c17.672%200%2032-14.328%2032-32v-352h352c17.672%200%2032-14.328%2032-32v-192c0-17.672-14.328-32-32-32z%22%3E%3C%2Fpath%3E%0A%3C%2Fsvg%3E'>
			<input ?onclick="removeBox()" class="separator" type="image" src='data:image/svg+xml;utf8,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20fill%3D%22%23999%22%20viewBox%3D%220%200%201024%201024%22%3E%3Cpath%20class%3D%22path1%22%20d%3D%22M128%20320v640c0%2035.2%2028.8%2064%2064%2064h576c35.2%200%2064-28.8%2064-64v-640h-704zM320%20896h-64v-448h64v448zM448%20896h-64v-448h64v448zM576%20896h-64v-448h64v448zM704%20896h-64v-448h64v448z%22%3E%3C%2Fpath%3E%0A%3Cpath%20class%3D%22path2%22%20d%3D%22M848%20128h-208v-80c0-26.4-21.6-48-48-48h-224c-26.4%200-48%2021.6-48%2048v80h-208c-26.4%200-48%2021.6-48%2048v80h832v-80c0-26.4-21.6-48-48-48zM576%20128h-192v-63.198h192v63.198z%22%3E%3C%2Fpath%3E%0A%3C%2Fsvg%3E'>
			<input ?onclick="linkBox()" type="image" src='data:image/svg+xml;utf8,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20fill%3D%22%23999%22%20viewBox%3D%220%200%20951%201024%22%3E%3Cpath%20class%3D%22path1%22%20d%3D%22M832%20694.857q0-22.857-16-38.857l-118.857-118.857q-16-16-38.857-16-24%200-41.143%2018.286%201.714%201.714%2010.857%2010.571t12.286%2012.286%208.571%2010.857%207.429%2014.571%202%2015.714q0%2022.857-16%2038.857t-38.857%2016q-8.571%200-15.714-2t-14.571-7.429-10.857-8.571-12.286-12.286-10.571-10.857q-18.857%2017.714-18.857%2041.714%200%2022.857%2016%2038.857l117.714%20118.286q15.429%2015.429%2038.857%2015.429%2022.857%200%2038.857-14.857l84-83.429q16-16%2016-38.286zM430.286%20292q0-22.857-16-38.857l-117.714-118.286q-16-16-38.857-16-22.286%200-38.857%2015.429l-84%2083.429q-16%2016-16%2038.286%200%2022.857%2016%2038.857l118.857%20118.857q15.429%2015.429%2038.857%2015.429%2024%200%2041.143-17.714-1.714-1.714-10.857-10.571t-12.286-12.286-8.571-10.857-7.429-14.571-2-15.714q0-22.857%2016-38.857t38.857-16q8.571%200%2015.714%202t14.571%207.429%2010.857%208.571%2012.286%2012.286%2010.571%2010.857q18.857-17.714%2018.857-41.714zM941.714%20694.857q0%2068.571-48.571%20116l-84%2083.429q-47.429%2047.429-116%2047.429-69.143%200-116.571-48.571l-117.714-118.286q-47.429-47.429-47.429-116%200-70.286%2050.286-119.429l-50.286-50.286q-49.143%2050.286-118.857%2050.286-68.571%200-116.571-48l-118.857-118.857q-48-48-48-116.571t48.571-116l84-83.429q47.429-47.429%20116-47.429%2069.143%200%20116.571%2048.571l117.714%20118.286q47.429%2047.429%2047.429%20116%200%2070.286-50.286%20119.429l50.286%2050.286q49.143-50.286%20118.857-50.286%2068.571%200%20116.571%2048l118.857%20118.857q48%2048%2048%20116.571z%22%3E%3C%2Fpath%3E%0A%3C%2Fsvg%3E'>
			<input ?onclick="unlinkBox()" type="image" src='data:image/svg+xml;utf8,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20fill%3D%22%23999%22%20viewBox%3D%220%200%20951%201024%22%3E%3Cpath%20class%3D%22path1%22%20d%3D%22M250.857%20726.286l-146.286%20146.286q-5.714%205.143-13.143%205.143-6.857%200-13.143-5.143-5.143-5.714-5.143-13.143t5.143-13.143l146.286-146.286q5.714-5.143%2013.143-5.143t13.143%205.143q5.143%205.714%205.143%2013.143t-5.143%2013.143zM347.429%20749.714v182.857q0%208-5.143%2013.143t-13.143%205.143-13.143-5.143-5.143-13.143v-182.857q0-8%205.143-13.143t13.143-5.143%2013.143%205.143%205.143%2013.143zM219.429%20621.714q0%208-5.143%2013.143t-13.143%205.143h-182.857q-8%200-13.143-5.143t-5.143-13.143%205.143-13.143%2013.143-5.143h182.857q8%200%2013.143%205.143t5.143%2013.143zM941.714%20694.857q0%2068.571-48.571%20116l-84%2083.429q-47.429%2047.429-116%2047.429-69.143%200-116.571-48.571l-190.857-191.429q-12-12-24-32l136.571-10.286%20156%20156.571q15.429%2015.429%2038.857%2015.714t38.857-15.143l84-83.429q16-16%2016-38.286%200-22.857-16-38.857l-156.571-157.143%2010.286-136.571q20%2012%2032%2024l192%20192q48%2049.143%2048%20116.571zM589.143%20281.143l-136.571%2010.286-156-156.571q-16-16-38.857-16-22.286%200-38.857%2015.429l-84%2083.429q-16%2016-16%2038.286%200%2022.857%2016%2038.857l156.571%20156.571-10.286%20137.143q-20-12-32-24l-192-192q-48-49.143-48-116.571%200-68.571%2048.571-116l84-83.429q47.429-47.429%20116-47.429%2069.143%200%20116.571%2048.571l190.857%20191.429q12%2012%2024%2032zM950.857%20329.143q0%208-5.143%2013.143t-13.143%205.143h-182.857q-8%200-13.143-5.143t-5.143-13.143%205.143-13.143%2013.143-5.143h182.857q8%200%2013.143%205.143t5.143%2013.143zM640%2018.286v182.857q0%208-5.143%2013.143t-13.143%205.143-13.143-5.143-5.143-13.143v-182.857q0-8%205.143-13.143t13.143-5.143%2013.143%205.143%205.143%2013.143zM872.571%20104.571l-146.286%20146.286q-6.286%205.143-13.143%205.143t-13.143-5.143q-5.143-5.714-5.143-13.143t5.143-13.143l146.286-146.286q5.714-5.143%2013.143-5.143t13.143%205.143q5.143%205.714%205.143%2013.143t-5.143%2013.143z%22%3E%3C%2Fpath%3E%0A%3C%2Fsvg%3E'>
		</div>
		<input type="color" style="position:absolute; top:-99999px; left:-99999px">
	</div>
</template>
<!-- mover template -->
<template id="msa-editor-mover">
	<style>
		:host {
			position: absolute;
		}
		input {
			cursor: move;
			padding: 5px;
			width: 24px;
			height: 24px;
			border: 1px solid #aaa;
			border-right: 0;
			border-radius: 5px 0px 0px 5px;
			box-shadow: -1pt 1pt 2pt 1pt #aaa;
		}
	</style>
	<input type="image" src='data:image/svg+xml;utf8,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20fill%3D%22%23999%22%20viewBox%3D%220%200%201024%201024%22%3E%3Cpath%20class%3D%22path1%22%20d%3D%22M512%200q18%200%2030.333%2012.333l150.667%20151q12.667%2012.667%2012.667%2030.333t-12.5%2030.167-30.167%2012.5-30.333-12.667l-78-78v323.667h323.667l-78-78q-12.667-12.667-12.667-30.333t12.5-30.167%2030.167-12.5%2030.333%2012.667l151%20150.667q12.333%2012.333%2012.333%2030.333t-12.333%2030l-151%20151q-12.667%2012.667-30.333%2012.667t-30.167-12.5-12.5-30.167%2012.667-30.333l78-78h-323.667v323.667l78-78q12.667-12.667%2030.333-12.667t30.167%2012.5%2012.5%2030.167-12.667%2030.333l-150.667%20151q-12.333%2012.333-30.333%2012.333-17.667%200-30-12.333l-151-151q-12.667-12.667-12.667-30.333t12.5-30.167%2030.167-12.5%2030.333%2012.667l78%2078v-323.667h-323.667l78%2078q12.667%2012.667%2012.667%2030.333t-12.5%2030.167-30.167%2012.5-30.333-12.667l-151-150.667q-12.333-12.333-12.333-30.333t12.333-30.333l151-150.667q12.667-12.667%2030.333-12.667t30.167%2012.5%2012.5%2030.167-12.667%2030.333l-78%2078h323.667v-323.667l-78%2078q-12.667%2012.667-30.333%2012.667t-30.167-12.5-12.5-30.167%2012.667-30.333l150.667-151q12.333-12.333%2030.333-12.333z%22%3E%3C%2Fpath%3E%0A%3C%2Fsvg%3E' />
</template>
<!-- createLink popup template -->
<template id="msa-editor-createLink-popup">
	Enter an URL:<br>
	<input type='text'><br>
	<button ?onclick="createLink()">OK</button>
</template>
<!-- linkBox popup template -->
<template id="msa-editor-linkBox-popup">
	Enter an URL:<br>
	<input type='text'><br>
	<button ?onclick="linkBox()">OK</button>
</template>
<!-- insertBox popup template -->
<template id="msa-editor-insertBox-popup">
	Enter an URL:<br>
	<input type='text'><br>
	<button ?onclick="insertBox()">OK</button>
</template>
<!-- showSource popup template -->
<template id="msa-editor-showSource-popup">
	cssText:<br>
	<textarea id='cssText' style='width:500px; height:100px'></textarea><br>
	innerHTML:<br>
	<textarea id='innerHTML' style='width:500px; height:300px'></textarea><br>
	<button ?onclick="updateSource()">OK</button>
</template>
<!-- createLink popup template -->
<template id="msa-editor-chain">
	<style>
		:host {
			display: none;
			position: absolute;
			width: 11px;
			height: 11px;
		}
		#selector {
			height:calc(100% - 10px);
			padding:5px;
			cursor: pointer;
		}
		#line {
			height:100%;
			background: #aaa;
		}
		#line.active {
			box-shadow: 0pt 0pt 3pt 1pt #aaf;
		}
	</style>
	<div id="selector">
		<div id="line" ?class="active?'active':''"></div>
	</div>
</template>
<script>
(function() {
	
	// editor ///////////////////////////////////////////////////////////////////////
	
	App.registerElement("msa-editor", {shadow:"#msa-editor",
		oncreate: function(){
			this.show = "text"
			// edit functions
			this.copy = function() { document.execCommand('copy', false) }
			this.cut = function() { document.execCommand('cut', false) }
			this.paste = function() { document.execCommand('paste', false) }
			this.undo = function() { document.execCommand('undo', false) }
			this.redo = function() { document.execCommand('redo', false) }
			// text functions
			this.bold = function() { document.execCommand('bold', false) }
			this.italic = function() { document.execCommand('italic', false) }
			this.underline = function(e) { document.execCommand('underline', false) }
			this.strikethrough = function() { document.execCommand('strikethrough', false) }
			this.removeFormat = function() { document.execCommand('formatBlock', false, 'div') }
			this.createLink = function() { showCreateLinkPopup() }
			this.unlink = function() { document.execCommand('unlink', false) }
			this.formatP = function() { document.execCommand('formatBlock', false, 'p') }
			this.formatH1 = function() { document.execCommand('formatBlock', false, 'h1') }
			this.formatH2 = function() { document.execCommand('formatBlock', false, 'h2') }
			// indent functions
			this.justifyLeft = function() { document.execCommand('justifyLeft', false) }
			this.justifyCenter = function() { document.execCommand('justifyCenter', false) }
			this.justifyRight = function() { document.execCommand('justifyRight', false) }
			this.justifyFull = function() { document.execCommand('justifyFull', false) }
			this.insertUnorderedList = function() { document.execCommand('insertUnorderedList', false) }
			this.insertOrderedList = function() { document.execCommand('insertOrderedList', false) }
			this.indent = function() { document.execCommand('indent', false) }
			this.outdent = function() { document.execCommand('outdent', false) }
			// color functions
			this.foreColor = function(){ this.inputColor.onchange = function(){ document.execCommand('foreColor', false, this.value) }; this.inputColor.click() }
			this.backColor = function(){ this.inputColor.onchange = function(){ document.execCommand('backColor', false, this.value) }; this.inputColor.click() }
			this.colorBackground = function() { var dom = Edition.selected; if(!dom) return; this.inputColor.oninput = function(){ dom.style.background = this.value }; this.inputColor.click() }
			// box functions
			this.insertBox = function() { var dom = Edition.selected; if(!dom || !(dom.edition && dom.edition.boxable)) return; insertBox(dom) }
			this.removeBox = function() { var dom = Edition.selected; if(!dom || !dom.isBox) return; removeBox(dom) }
			this.linkBox = function() { showLinkBoxPopup(); }
			this.unlinkBox = unlinkBox
			// dev functions
			this.showSource = function() { var dom = Edition.selected; console.log(dom); if(!dom) return; showShowSourcePopup(dom) }
			this.inputColor = this.shadowRoot.querySelector(".editor input[type=color]");
			// bind
			Bind(this.shadowRoot, this)
		}
	})
	
	var showEditor = function() {
		if(Edition.nbSelectable==0) {
			if(Edition.editor) {
				Edition.editor.style.display = 'none'
				Edition.editor.edition.mover.style.display = 'none'
			}
			return
		}
		if(!Edition.editor) {
			Edition.editor = document.createElement('msa-editor')
			document.body.appendChild(Edition.editor)
			Edition.makeMovable(Edition.editor)
		}
		Edition.editor.style.display = ''
		Edition.editor.edition.mover.style.display = ''
	}
	
	// show source
	App.registerElement("msa-editor-showSource-popup", {shadow:"#msa-editor-showSource-popup",
		oncreate: function(){
			this.updateSource = function(){
				var dom = showSourcePopup.dom
				dom.cssText = this.shadowRoot.querySelector('#cssText').value
				dom.innerHTML = this.shadowRoot.querySelector('#innerHTML').value
				showSourcePopup.close()
			}
			Bind(this.shadowRoot, this)
		}
	})
	var showSourcePopupDom = document.createElement("msa-editor-showSource-popup")
	var showSourcePopup = picoModal(showSourcePopupDom)
	var showShowSourcePopup = function(dom) {
		showSourcePopup.dom = dom
		showSourcePopupDom.shadowRoot.querySelector("#cssText").value = dom.cssText || ""
		showSourcePopupDom.shadowRoot.querySelector("#innerHTML").value = dom.innerHTML
		showSourcePopup.show()
	}
	
	
	
	// box //////////////////////////////////////////////////////////////////////
	
	var isBox = function(dom) {
		var tag = dom.tagName
		return (tag=="msa-box" || tag=="msa-box-partial")
	}
	
	// insert box
	var insertBox = function(dom) {
		var box = document.createElement("msa-box")
		box.style.top = "50px"
		box.style.left = "50px"
		box.style.width = "200px"
		box.style.height = "200px"
		box.style.outline = "1px dashed #aaa"
		dom.appendChild(box)
		makeBoxEditable(box)
	}
	
	App.registerElement("msa-editor-insertBox-popup", {shadow:"#msa-editor-insertBox-popup",
		oncreate: function(){
			this.insertBox = function() {
				insertBox(insertBoxPopup.dom, this.shadowRoot.querySelector("input").value)
				insertBoxPopup.close()
			}
			Bind(this.shadowRoot, this)
		}
	})
	var insertBoxPopup = picoModal(document.createElement("msa-editor-insertBox-popup"))
	var showInsertBoxPopup = function(dom) {
		insertBoxPopup.dom = dom
		insertBoxPopup.show()
	}
	
	// remove box
	var removeBox = function(dom) {
		if(!isBox(dom)) return
		dom.remove()
	}
	
	// link box
	App.registerElement("msa-editor-linkBox-popup", {shadow:"#msa-editor-linkBox-popup",
		oncreate: function(){
			this.linkBox = function() {
				var box = linkBoxPopup.box
				var link = this.shadowRoot.querySelector("input").value
				box.outerHTML = box.outerHTML.replace("<msa-box ","<msa-box-partial ")
				box.setAttribute("src",link)
				createLinkPopup.close()
			}
			Bind(this.shadowRoot, this)
		}
	})
	var linkBoxPopup = picoModal(document.createElement("msa-editor-linkBox-popup"))
	var showLinkBoxPopup = function() {
		var selected = Edition.selected
		if(!selected.isBox) return
		linkBoxPopup.box = selected
		linkBoxPopup.show()
	}
	
	// unlink box
	var unlinkBox = function() {
		var selected = Edition.selected
		if(!selected.isBox) return
		selected.outerHTML = selected.outerHTML.replace("<msa-box-partial ","<msa-box ")
	}
	
	// makeBoxEditable
	var makeBoxEditable = function(box, editable) {
		editable = (editable!==false) // change undefined into true (to have resize all)
		if(!box.isBoxPartial) makeEditable(box, editable)
		makeResizable(box, editable)
		makeMovable(box, editable)
		makeChainableIfNeeded(box)
		makeSelectableIfNeeded(box)
	}
	
	
	
	// selectable ////////////////////////////////////////////////////////////////////
	
	var makeSelectableIfNeeded = function(dom) {
		var edition = dom.edition, parent = dom.parentNode, parentEdition = parent && parent.edition
		var selectable = edition && (edition.boxable || edition.editable)
		selectable |=  parentEdition && parentEdition.boxable && isBox(dom)
		makeSelectable(dom, selectable)
	}
	
	var makeSelectable = function(dom, selectable) {
		if(selectable===undefined) selectable = true
		if(!dom.edition) dom.edition = {}
		if(selectable && !dom.edition.selectable) {
			Edition.nbSelectable += 1
		} else if(!selectable && dom.edition.selectable) {
			Edition.nbSelectable -= 1
			dom.classList.remove("selected_for_edition")
		}
		dom.edition.selectable = selectable
		addSelectableEventListener(dom)
		showEditor()
	}
	
	var select = function(dom) {
		unselect()
		Edition.selected = dom
		Edition.isSelectedBoxable = dom.edition.boxable
		Edition.isSelectedEditable = dom.edition.editable
		dom.classList.add("selected_for_edition")
		showChains(dom, true)
	}
	
	var unselect = function(dom) {
		if(!Edition.selected) return
		if(dom && Edition.selected!=dom) return
		if(!dom) dom = Edition.selected
		Edition.selected.classList.remove("selected_for_edition")
		Edition.selected = null
		Edition.isSelectedBoxable = false
		Edition.isSelectedEditable = false
		showChains(dom, false)
	}
	
	var selectedAlreadyChosen = false
	var addSelectableEventListener = function(dom) {
		var edition = dom.edition
		if(edition.selectableListernersAdded) return
		edition.selectableListernersAdded = true
	
		dom.addEventListener("click", function(){
			if(!this.edition.selectable) return
			if(selectedAlreadyChosen) return
			select(this)
			selectedAlreadyChosen = true
		})
		document.addEventListener("click", function(){
			selectedAlreadyChosen = false
		})
	}
	
	
	
	// boxable ////////////////////////////////////////////////////////////////////
	
	var makeBoxable = function(dom, boxable) {
		if(boxable===undefined) boxable = true
		if(!dom.edition) dom.edition = {}
		var wasBoxable = dom.edition.boxable
		dom.edition.boxable = boxable
		if(boxable && !wasBoxable) {
			saveOriginalHtmlAndCss(dom)
			dom.classList.add("boxable")
			var boxes = dom.querySelectorAll("msa-box, msa-box-partial")
			for(var b=0, len=boxes.length; b<len; ++b)
				makeBoxEditable(boxes[b])
		} else if(!boxable && wasBoxable) {
			dom.classList.remove("boxable")
			var boxes = dom.querySelectorAll("msa-box, msa-box-partial")
			for(var b=0, len=boxes.length; b<len; ++b)
				makeBoxEditable(boxes[b], false)
		}
		makeSelectableIfNeeded(dom)
		if(boxable && !wasBoxable && dom.edition.selectable) select(dom)
	}
	
	
	
	// editable ////////////////////////////////////////////////////////////////////
	
	var makeEditable = function(dom, editable) {
		if(editable===undefined) editable = true
		if(!dom.edition) dom.edition = {}
		var wasEditable = dom.edition.editable
		dom.edition.editable = editable
		if(editable && !wasEditable) {
			dom.setAttribute("contenteditable","true")
			saveOriginalHtmlAndCss(dom)
		} else if(!editable && wasEditable) {
			dom.removeAttribute("contenteditable")
		}
		makeSelectableIfNeeded(dom)
	}
	
	
	// movable ////////////////////////////////////////////////////////////////////
	
	var makeMovable = function(dom, movable) {
		if(movable===undefined) movable = true
		if(!dom.edition) dom.edition = {}
		if(movable && !dom.edition.movable) {
			saveOriginalHtmlAndCss(dom)
			var mover = document.createElement("msa-editor-mover")
			mover.linkTo(dom)
			document.body.appendChild(mover)
		} else if(!movable && dom.edition.movable) {
			dom.edition.mover.remove()
		}
		dom.edition.movable = (movable!=false)
	}
	
	App.registerElement("msa-editor-mover", {shadow:"#msa-editor-mover",
		oncreate: function(){
			this.linkTo = function(target) {
				this.target = target
				target.edition.mover = this
				var targetPos = target.getBoundingClientRect();
				this.style.left = (targetPos.left-36)+"px"
				this.style.top = targetPos.top+"px"
			}
			this.addEventListener("mousedown", function(evt){
				Edition.movingMover = this
				this.originalX = this.offsetLeft
				this.originalY = this.offsetTop
				this.originalMouseX = evt.pageX
				this.originalMouseY = evt.pageY
				this.originalTargetX = this.target.offsetLeft
				this.originalTargetY = this.target.offsetTop
				// avoid selecting content in page
				evt.preventDefault()
			})
		}
	})
	document.addEventListener("mouseup", function(evt){
		Edition.movingMover = null
	})
	document.addEventListener("mousemove", function(evt){
		var mover = Edition.movingMover
		if(!mover) return
		// determine mouse movement
		var mouseDiffX = evt.pageX - mover.originalMouseX
		var mouseDiffY = evt.pageY - mover.originalMouseY
		mover.style.left = (mover.originalX + mouseDiffX)+"px"
		mover.style.top = (mover.originalY + mouseDiffY)+"px"
		setPos(mover.target, {
			left:(mover.originalTargetX + mouseDiffX),
			top:(mover.originalTargetY + mouseDiffY)
		})
		updateChainsPos(mover.target)
	})
	
	
	
	// resizable ////////////////////////////////////////////////////////////////////
	
	var makeResizableDefaultArgs = ["right","bottom"]
	var makeResizableTrueArgs = ["right","left","bottom","top"]
	var makeResizableFalseArgs = []
	var makeResizable = function(dom, resizable) {
		if(resizable===undefined) resizable = makeResizableDefaultArgs
		if(resizable===true) resizable = makeResizableTrueArgs
		if(resizable===false) resizable = makeResizableFalseArgs
		if(resizable.length===undefined) resizable = [resizable]
		if(!dom.edition) dom.edition = {}
		if(dom.edition.resizableDirs===undefined) dom.edition.resizableDirs = {}
		dom.edition.resizableDirs.top = (resizable.indexOf("top")!=-1)
		dom.edition.resizableDirs.bottom = (resizable.indexOf("bottom")!=-1)
		dom.edition.resizableDirs.left = (resizable.indexOf("left")!=-1)
		dom.edition.resizableDirs.right = (resizable.indexOf("right")!=-1)
		dom.edition.resizable = resizable.length>0
		if(dom.edition.resizable) {
			saveOriginalHtmlAndCss(dom)
			addResizableEventListener(dom)
		}
	}
	
	var addResizableEventListener = function(dom) {
		var edition = dom.edition
		if(edition.resizableListernersAdded) return
		edition.resizableListernersAdded = true
		
		dom.addEventListener("mousemove", function(evt){
			if(Edition.resizingDom || !this.edition.resizable) return
			// compute position
			var mouseX = evt.layerX, mouseY = evt.layerY
			var borderLeft = this.edition.resizableDirs.left && (mouseX<10)
			var borderRight = this.edition.resizableDirs.right && (this.offsetWidth-mouseX<10)
			var borderTop = this.edition.resizableDirs.top && (mouseY<10)
			var borderBottom = this.edition.resizableDirs.bottom && (this.offsetHeight-mouseY<10)
			// determine action
			this.edition.resizeWidth = (borderRight ? 1 : (borderLeft ? -1 : 0))
			this.edition.resizeHeight = (borderBottom ? 1 : (borderTop ? -1 : 0))
			// determine cursor
			var cursor = ""
			if(this.edition.resizeHeight==1) cursor += "s"
			if(this.edition.resizeHeight==-1) cursor += "n"
			if(this.edition.resizeWidth==1) cursor += "e"
			if(this.edition.resizeWidth==-1) cursor += "w"
			if(cursor!="") cursor += "-resize"
			this.style.cursor = cursor
		})
		
		dom.addEventListener("mouseleave", function(evt){
			if(Edition.resizingDom || !this.edition.resizable) return
			this.style.cursor = ""
		})
		
		dom.addEventListener("mousedown", function(evt){
			if(Edition.resizingDom || (!this.edition.resizeWidth && !this.edition.resizeHeight)) return
			// start resizing
			Edition.resizingDom = this
			Edition.originalDomX = this.offsetLeft
			Edition.originalDomY = this.offsetTop
			Edition.originalDomWidth = this.offsetWidth
			Edition.originalDomHeight = this.offsetHeight
			Edition.originalMouseX = evt.pageX
			Edition.originalMouseY = evt.pageY
			var mover = this.edition.mover
			if(mover) {
				Edition.originalMoverX = mover.offsetLeft
				Edition.originalMoverY = mover.offsetTop
			}
			// avoid selecting content in page
			evt.preventDefault()
		})
	}
	
	document.addEventListener("mouseup", function(evt){
		// stop resizing
		Edition.resizingDom = null
	})
	
	document.addEventListener("mousemove", function(evt){
		if(!Edition.resizingDom) return
		var domEdition = Edition.resizingDom.edition
		// determine mouse movement
		var mouseDiffX = evt.pageX - Edition.originalMouseX
		var mouseDiffY = evt.pageY - Edition.originalMouseY
		// determine actions
		var doMoveX = (domEdition.resizeWidth==-1)
		var doMoveY = (domEdition.resizeHeight==-1)
		var doResizeWidth = (domEdition.resizeWidth!==0)
		var doResizeHeight = (domEdition.resizeHeight!==0)
		// dom resizing
		if(doResizeWidth) var newWidth = Edition.originalDomWidth + domEdition.resizeWidth*mouseDiffX
		if(doResizeHeight) var newHeight = Edition.originalDomHeight + domEdition.resizeHeight*mouseDiffY
		// keep aspect ratio when resizing both width & height
		if(doResizeWidth && doResizeHeight) {
			var newWidth2 = Math.max(newWidth, Math.ceil(newHeight*Edition.originalDomWidth/Edition.originalDomHeight))
			newHeight = Math.max(newHeight, Math.ceil(newWidth*Edition.originalDomHeight/Edition.originalDomWidth))
			newWidth = newWidth2
		}
		// dom min width & height
		var newPos = {}
		if(domEdition.resizeWidth) newPos.width = Math.max(10,newWidth)
		if(domEdition.resizeHeight) newPos.height = Math.max(10,newHeight)
		// dom move due to resizing
		if(domEdition.resizeWidth==-1) {
			var deltaX = (newWidth - Edition.originalDomWidth)
			newPos.left = (Edition.originalDomX - deltaX)
			if(domEdition.mover) domEdition.mover.style.left = (Edition.originalMoverX - deltaX)+"px"
		}
		if(domEdition.resizeHeight==-1) {
			var deltaY = (newHeight - Edition.originalDomHeight)
			newPos.top = (Edition.originalDomY - deltaY)
			if(domEdition.mover) domEdition.mover.style.top = (Edition.originalMoverY - deltaY)+"px"
		}
		setPos(Edition.resizingDom, newPos)
		updateChainsPos(Edition.resizingDom)
	})
	
	
	
	// chainable //////////////////////////////////////////////////////////////////////////////
	
	
	var makeChainableIfNeeded = function(dom) {
		var edition = dom.edition
		var chainable = edition && (edition.movable || edition.resizable)
		makeChainable(dom, chainable)
	}
	
	var makeChainable = function(dom, chainable) {
		if(!dom.edition) dom.edition = {}
		dom.edition.chainable = chainable
		var chains = dom.edition.chains
		if(chainable) {
			// create invisible chains (if needed)
			if(!chains) {
				chains = dom.edition.chains = { left:null, right:null, top:null, bottom:null }
				for(var type in chains) {
					var chain = dom.edition.chains[type] = document.createElement("msa-editor-chain")
					chain.init(type, dom)
					document.body.appendChild(chain)
				}
			}
			// determine if chains are active
			var style = dom.style
			var width = style.width, height = style.height
			var top = style.top, bottom = style.bottom, left = style.left, right = style.right
			var leftChained = chains.left.active = (left && left!="")
			chains.right.active = (!leftChained || width.indexOf("calc(100% - ")!=-1)
			var topChained = chains.top.active = (top && top!="")
			chains.bottom.active = (!topChained || height.indexOf("calc(100% - ")!=-1)
		} else {
			// remove chains (if exist)
			if(!chains) return
			for(var type in chains) chains[type].remove()
			dom.edition.chains = null
		}
	}
	
	App.registerElement("msa-editor-chain", {shadow:"#msa-editor-chain",
		oncreate: function(){
			this.active = false
			Bind(this.shadowRoot, this)
			this.init = function(type, target) {
				this.type = type
				this.target = target
				this.updatePos()
			}
			this.updatePos = function() {
				var target = this.target, parent = target.parentNode, type = this.type, style = this.style
				var targetPos = target.getBoundingClientRect()
				var parentPos = parent.getBoundingClientRect()
				if(type=="left" || type=="right") {
					style.top = targetPos.top + target.offsetHeight/2 + "px"
					style.height = ""
				}
				if(type=="left") {
					style.left = parentPos.left + "px"
					style.width = (targetPos.left - parentPos.left) + "px"
				}
				if(type=="right") {
					style.left = (targetPos.left + target.offsetWidth) + "px"
					style.width = ( (parentPos.left + parent.offsetWidth) - (targetPos.left + target.offsetWidth) ) + "px"
				}
				if(type=="top" || type=="bottom") {
					style.left = targetPos.left + target.offsetWidth/2 + "px"
					style.width = ""
				}
				if(type=="top") {
					style.top = parentPos.top + "px"
					style.height = (targetPos.top - parentPos.top) + "px"
				}
				if(type=="bottom") {
					style.top = (targetPos.top + target.offsetHeight) + "px"
					style.height = ( (parentPos.top + parent.offsetHeight) - (targetPos.top + target.offsetHeight) ) + "px"
				}
			}
			this.addEventListener("click", function(evt){
				this.active = !this.active
				var type = this.type
				if(type=="left") var opposedType = "right"
				else if(type=="right") var opposedType = "left"
				else if(type=="top") var opposedType = "bottom"
				else if(type=="bottom") var opposedType = "top"
				var target = this.target, chains = target.edition.chains, targetStyle = target.style, parent = target.parentNode
				var opposedChain = chains[opposedType]
				if(!opposedChain.active) opposedChain.active = true
				setPos(this.target)
				// avoid selecting content in page
				evt.preventDefault()
			})
		}
	})
	
	var showChains = function(dom, show) {
		var chains = dom.edition.chains
		if(!chains) return
		for(var type in chains) {
			var chain = chains[type]
			if(!chain) continue
			if(show && dom.edition.chainable) chain.style.display = 'block'
			else chain.style.display = ''
		}
	}
	
	var updateChainsPos = function(dom) {
		if(!dom.edition || !dom.edition.chainable) return
		var chains = dom.edition.chains
		if(!chains) return
		for(var type in chains) chains[type].updatePos()
	}
	
	
	
	// position ///////////////////////////////////////////////////////////////////
	
	var setPos = function(dom, args) {
		var chains = dom.edition.chains
		var leftChainActive = chains ? chains.left.active : true
		var rightChainActive = chains ? chains.right.active : false
		var topChainActive = chains ? chains.top.active : true
		var bottomChainActive = chains ? chains.bottom.active : false
		var parent = dom.parentNode
		var left = (args && args.left!==undefined) ? args.left : dom.offsetLeft
		var width = (args && args.width!==undefined) ? args.width : dom.offsetWidth
		var top = (args && args.top!==undefined) ? args.top : dom.offsetTop
		var height = (args && args.height!==undefined) ? args.height : dom.offsetHeight
		// set horizontal pos
		if(leftChainActive && !rightChainActive) {
			var newLeft = left +"px"
			var newRight = ""
			var newWidth = width +"px"
		}
		else if(!leftChainActive && rightChainActive) {
			var newLeft = ""
			var newRight = (parent.offsetWidth - (left + width)) +"px"
			var newWidth = width +"px"
		}
		else {
			var newLeft = left +"px"
			var newRight = ""
			var newWidth = "calc(100% - "+(parent.offsetWidth - width)+"px)"
		}
		dom.style.left = newLeft
		dom.style.right = newRight
		dom.style.width = newWidth
		// set vertical pos
		if(topChainActive && !bottomChainActive) {
			var newTop = top +"px"
			var newBottom = ""
			var newHeight = height +"px"
		}
		else if(!topChainActive && bottomChainActive) {
			var newTop = ""
			var newBottom = (parent.offsetHeight - (top + height)) +"px"
			var newHeight = height +"px"
		}
		else {
			var newTop = top +"px"
			var newBottom = ""
			var newHeight = "calc(100% - "+(parent.offsetHeight - height)+"px)"
		}
		dom.style.top = newTop
		dom.style.bottom = newBottom
		dom.style.height = newHeight
	}
	
	// various //////////////////////////////////////////////////////////////
	
	var stop = function(dom) {
		// remove boxable, editable, movable & resizable modes
		makeBoxable(dom, false)
		makeEditable(dom, false)
		makeMovable(dom, false)
		makeResizable(dom, false)
	}
	
	var cancel = function(dom) {
		stop(dom)
		// put back original html & css
		var edition = dom.edition
		if(edition.originalInnerHTML!==undefined) {
			dom.innerHTML = edition.originalInnerHTML
			edition.originalInnerHTML = undefined
		}
		if(edition.originalCssText!==undefined) {
			dom.style.cssText = edition.originalCssText
			edition.originalCssText = undefined
		}
	}
	
	var saveOriginalHtmlAndCss = function(dom) {
		var edition = dom.edition
		if(edition.originalInnerHTML===undefined)
			edition.originalInnerHTML = dom.innerHTML
		if(edition.originalCssText===undefined)
			edition.originalCssText = dom.style.cssText || ""
	}
	
	Edition = {
		nbSelectable: 0,
		makeBoxable: makeBoxable,
		makeEditable: makeEditable,
		makeMovable: makeMovable,
		makeResizable: makeResizable,
		stop: stop,
		cancel: cancel
	}
})();
</script>

